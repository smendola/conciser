NBJ Condenser - Architecture Overview
======================================

See ARCHITECTURE.md for the full technical reference.

This file is a plain-text summary for quick reference.


SYSTEM OVERVIEW
---------------

NBJ Condenser condenses YouTube videos using AI. It has four interfaces:
  - CLI: `nbj condense <url>`
  - Flask Server: server/app.py (REST API, port 5000)
  - Chrome Extension: chrome-extension/ (submits to server)
  - Android App: android/ package com.nbj (share intent -> server)


PIPELINE STAGES
---------------

1. FETCH (downloader.py)
   - yt-dlp downloads video as MP4
   - Extracts metadata: video_id, title, duration, uploader
   - Resume: skips if video already in temp/

2. TRANSCRIBE (transcriber.py)
   - ffmpeg extracts 16kHz WAV audio
   - OpenAI Whisper API returns timestamped transcript
   - Resume: skips if transcript.json already exists

3. CONDENSE (condenser.py)
   - Provider: OpenAI gpt-5.2 (default) or Claude claude-sonnet-4-20250514
   - Three-level prompt: system (L1) + strategy (L2) + user (L3)
   - Aggressiveness levels 1-10 control how much is cut
   - Returns: condensed_script, key_points_preserved, stats
   - Optional: prepend_intro adds numbered key take-aways to TTS script
   - Optional: pre-initialized Responses API chains (chain_store.py)

4. TTS / SPEECH GENERATION
   - Edge TTS (default, free): edge_tts.py, Microsoft neural voices
   - ElevenLabs (optional, paid): voice_cloner.py, voice cloning

5. VIDEO GENERATION / COMPOSITION
   - slideshow (default): scene-detected keyframes -> MP4
   - audio_only: TTS audio output only -> MP3 (fastest)
   - static: single extracted frame -> MP4
   - avatar: D-ID talking head -> MP4 (expensive, optional)


CLI COMMANDS
------------

  nbj condense <url>        Condense a YouTube video
  nbj info <url>            Show video metadata
  nbj init                  Interactive API key setup
  nbj check                 Configuration diagnostics
  nbj voices                List available TTS voices
  nbj tts <file>            Convert text file to speech
  nbj tts-samples           Generate voice preview samples
  nbj show-script <url>     Show transcript or condensed script

Key options for `nbj condense`:
  --aggressiveness, -a  1-10 (default: 5)
  --quality, -q         720p, 1080p, 4k (default: 1080p)
  --video-gen-mode      slideshow, audio_only, static, avatar
  --voice               e.g. "edge/ryan" or "en-GB-RyanNeural"
  --tts-provider        edge (default free) or elevenlabs
  --speech-rate         e.g. "+10%", "-25%"
  --prepend-intro       Add numbered key take-aways intro
  --resume/--no-resume  Resume from intermediate files (default: resume)


SERVER API ENDPOINTS
--------------------

  GET  /start                  Extension download & install page
  GET  /extension.zip          Download Chrome extension ZIP
  POST /api/condense           Submit job {url, aggressiveness, voice, ...}
  GET  /api/status/<id>        Check job status
  GET  /api/download/<id>      Stream output file
  GET  /api/strategies         Aggressiveness level descriptions
  GET  /api/voices?locale=en   Edge TTS voices by locale
  GET  /api/jobs               List all jobs
  GET  /health                 Health check


KEY FILES
---------

  src/main.py                 CLI entry point
  src/pipeline.py             CondenserPipeline (orchestrator)
  src/config.py               Pydantic settings (reads .env)
  src/modules/downloader.py   yt-dlp wrapper
  src/modules/transcriber.py  Whisper API wrapper
  src/modules/condenser.py    OpenAI/Claude condensation
  src/modules/edge_tts.py     Edge TTS (free, default)
  src/modules/voice_cloner.py ElevenLabs voice cloning (optional)
  src/modules/video_generator.py  D-ID avatar (optional)
  src/modules/compositor.py   ffmpeg video assembly
  src/utils/audio_utils.py    Audio processing helpers
  src/utils/video_utils.py    Video processing + scene detection
  src/utils/prompt_templates.py   LLM prompt templates
  src/utils/chain_store.py    OpenAI Responses API chain cache
  src/utils/exceptions.py     Custom exceptions
  server/app.py               Flask REST server
  chrome-extension/popup.js   Extension logic
  android/.../MainActivity.kt Android main activity


REQUIRED API KEYS (.env)
-------------------------

  OPENAI_API_KEY      Required (Whisper + default condensation)
  ANTHROPIC_API_KEY   Optional (Claude condensation provider)
  ELEVENLABS_API_KEY  Optional (voice cloning TTS)
  DID_API_KEY         Optional (avatar video mode only)


DEPENDENCIES
------------

Required:
  Python 3.10+, ffmpeg
  yt-dlp, openai, edge-tts, flask, flask-cors
  click, pydantic, pydantic-settings, colorama

Optional:
  anthropic (Claude provider)
  elevenlabs (voice cloning)
  scenedetect (slideshow mode)
